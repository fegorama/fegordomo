/**
 * @file 	MqttClient.h
 * @brief 	Cliente de MQTT
 * 
 * @author 	Fernando Gonz√°lez (Fegor)
 * @date 	15/10/2021
 * @version 1.0.0
 * 
 * Licensed under the EUPL-1.2-or-later
 */
#ifndef MQTTCLIENT_H
#define MQTTCLIENT_H

#include <WiFiClientSecure.h>
// #include <WiFi.h>
#include <PubSubClient.h>   

using namespace std;

class MqttClient {
    private:
        const char* mqtt_topic_receiver = "garden";
        const char* mqtt_topic_publish = "control";
        const char* mqtt_server = "192.168.1.100"; // "broker.mqtt-dashboard.com";
        /*
        const char *ca_cert = "-----BEGIN CERTIFICATE-----\n\
MIIFFjCCAv6gAwIBAgIRAJErCErPDBinU/bWLiWnX1owDQYJKoZIhvcNAQELBQAw\n\
TzELMAkGA1UEBhMCVVMxKTAnBgNVBAoTIEludGVybmV0IFNlY3VyaXR5IFJlc2Vh\n\
cmNoIEdyb3VwMRUwEwYDVQQDEwxJU1JHIFJvb3QgWDEwHhcNMjAwOTA0MDAwMDAw\n\
WhcNMjUwOTE1MTYwMDAwWjAyMQswCQYDVQQGEwJVUzEWMBQGA1UEChMNTGV0J3Mg\n\
RW5jcnlwdDELMAkGA1UEAxMCUjMwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEK\n\
AoIBAQC7AhUozPaglNMPEuyNVZLD+ILxmaZ6QoinXSaqtSu5xUyxr45r+XXIo9cP\n\
R5QUVTVXjJ6oojkZ9YI8QqlObvU7wy7bjcCwXPNZOOftz2nwWgsbvsCUJCWH+jdx\n\
sxPnHKzhm+/b5DtFUkWWqcFTzjTIUu61ru2P3mBw4qVUq7ZtDpelQDRrK9O8Zutm\n\
NHz6a4uPVymZ+DAXXbpyb/uBxa3Shlg9F8fnCbvxK/eG3MHacV3URuPMrSXBiLxg\n\
Z3Vms/EY96Jc5lP/Ooi2R6X/ExjqmAl3P51T+c8B5fWmcBcUr2Ok/5mzk53cU6cG\n\
/kiFHaFpriV1uxPMUgP17VGhi9sVAgMBAAGjggEIMIIBBDAOBgNVHQ8BAf8EBAMC\n\
AYYwHQYDVR0lBBYwFAYIKwYBBQUHAwIGCCsGAQUFBwMBMBIGA1UdEwEB/wQIMAYB\n\
Af8CAQAwHQYDVR0OBBYEFBQusxe3WFbLrlAJQOYfr52LFMLGMB8GA1UdIwQYMBaA\n\
FHm0WeZ7tuXkAXOACIjIGlj26ZtuMDIGCCsGAQUFBwEBBCYwJDAiBggrBgEFBQcw\n\
AoYWaHR0cDovL3gxLmkubGVuY3Iub3JnLzAnBgNVHR8EIDAeMBygGqAYhhZodHRw\n\
Oi8veDEuYy5sZW5jci5vcmcvMCIGA1UdIAQbMBkwCAYGZ4EMAQIBMA0GCysGAQQB\n\
gt8TAQEBMA0GCSqGSIb3DQEBCwUAA4ICAQCFyk5HPqP3hUSFvNVneLKYY611TR6W\n\
PTNlclQtgaDqw+34IL9fzLdwALduO/ZelN7kIJ+m74uyA+eitRY8kc607TkC53wl\n\
ikfmZW4/RvTZ8M6UK+5UzhK8jCdLuMGYL6KvzXGRSgi3yLgjewQtCPkIVz6D2QQz\n\
CkcheAmCJ8MqyJu5zlzyZMjAvnnAT45tRAxekrsu94sQ4egdRCnbWSDtY7kh+BIm\n\
lJNXoB1lBMEKIq4QDUOXoRgffuDghje1WrG9ML+Hbisq/yFOGwXD9RiX8F6sw6W4\n\
avAuvDszue5L3sz85K+EC4Y/wFVDNvZo4TYXao6Z0f+lQKc0t8DQYzk1OXVu8rp2\n\
yJMC6alLbBfODALZvYH7n7do1AZls4I9d1P4jnkDrQoxB3UqQ9hVl3LEKQ73xF1O\n\
yK5GhDDX8oVfGKF5u+decIsH4YaTw7mP3GFxJSqv3+0lUFJoi5Lc5da149p90Ids\n\
hCExroL1+7mryIkXPeFM5TgO9r0rvZaBFOvV2z0gp35Z0+L4WPlbuEjN/lxPFin+\n\
HlUjr8gRsI3qfJOQFy/9rKIJR0Y/8Omwt/8oTWgy1mdeHmmjk7j1nYsvC9JSQ6Zv\n\
MldlTTKB3zhThV1+XWYp6rjd5JW1zbVWEkLNxE7GJThEUG3szgBVGP7pSWTUTsqX\n\
nLRbwHOoq7hHwg==\n\
-----END CERTIFICATE-----\n";
*/
const char *ca_cert = "-----BEGIN CERTIFICATE-----\n\
MIIFYDCCBEigAwIBAgIQQAF3ITfU6UK47naqPGQKtzANBgkqhkiG9w0BAQsFADA/\n\
MSQwIgYDVQQKExtEaWdpdGFsIFNpZ25hdHVyZSBUcnVzdCBDby4xFzAVBgNVBAMT\n\
DkRTVCBSb290IENBIFgzMB4XDTIxMDEyMDE5MTQwM1oXDTI0MDkzMDE4MTQwM1ow\n\
TzELMAkGA1UEBhMCVVMxKTAnBgNVBAoTIEludGVybmV0IFNlY3VyaXR5IFJlc2Vh\n\
cmNoIEdyb3VwMRUwEwYDVQQDEwxJU1JHIFJvb3QgWDEwggIiMA0GCSqGSIb3DQEB\n\
AQUAA4ICDwAwggIKAoICAQCt6CRz9BQ385ueK1coHIe+3LffOJCMbjzmV6B493XC\n\
ov71am72AE8o295ohmxEk7axY/0UEmu/H9LqMZshftEzPLpI9d1537O4/xLxIZpL\n\
wYqGcWlKZmZsj348cL+tKSIG8+TA5oCu4kuPt5l+lAOf00eXfJlII1PoOK5PCm+D\n\
LtFJV4yAdLbaL9A4jXsDcCEbdfIwPPqPrt3aY6vrFk/CjhFLfs8L6P+1dy70sntK\n\
4EwSJQxwjQMpoOFTJOwT2e4ZvxCzSow/iaNhUd6shweU9GNx7C7ib1uYgeGJXDR5\n\
bHbvO5BieebbpJovJsXQEOEO3tkQjhb7t/eo98flAgeYjzYIlefiN5YNNnWe+w5y\n\
sR2bvAP5SQXYgd0FtCrWQemsAXaVCg/Y39W9Eh81LygXbNKYwagJZHduRze6zqxZ\n\
Xmidf3LWicUGQSk+WT7dJvUkyRGnWqNMQB9GoZm1pzpRboY7nn1ypxIFeFntPlF4\n\
FQsDj43QLwWyPntKHEtzBRL8xurgUBN8Q5N0s8p0544fAQjQMNRbcTa0B7rBMDBc\n\
SLeCO5imfWCKoqMpgsy6vYMEG6KDA0Gh1gXxG8K28Kh8hjtGqEgqiNx2mna/H2ql\n\
PRmP6zjzZN7IKw0KKP/32+IVQtQi0Cdd4Xn+GOdwiK1O5tmLOsbdJ1Fu/7xk9TND\n\
TwIDAQABo4IBRjCCAUIwDwYDVR0TAQH/BAUwAwEB/zAOBgNVHQ8BAf8EBAMCAQYw\n\
SwYIKwYBBQUHAQEEPzA9MDsGCCsGAQUFBzAChi9odHRwOi8vYXBwcy5pZGVudHJ1\n\
c3QuY29tL3Jvb3RzL2RzdHJvb3RjYXgzLnA3YzAfBgNVHSMEGDAWgBTEp7Gkeyxx\n\
+tvhS5B1/8QVYIWJEDBUBgNVHSAETTBLMAgGBmeBDAECATA/BgsrBgEEAYLfEwEB\n\
ATAwMC4GCCsGAQUFBwIBFiJodHRwOi8vY3BzLnJvb3QteDEubGV0c2VuY3J5cHQu\n\
b3JnMDwGA1UdHwQ1MDMwMaAvoC2GK2h0dHA6Ly9jcmwuaWRlbnRydXN0LmNvbS9E\n\
U1RST09UQ0FYM0NSTC5jcmwwHQYDVR0OBBYEFHm0WeZ7tuXkAXOACIjIGlj26Ztu\n\
MA0GCSqGSIb3DQEBCwUAA4IBAQAKcwBslm7/DlLQrt2M51oGrS+o44+/yQoDFVDC\n\
5WxCu2+b9LRPwkSICHXM6webFGJueN7sJ7o5XPWioW5WlHAQU7G75K/QosMrAdSW\n\
9MUgNTP52GE24HGNtLi1qoJFlcDyqSMo59ahy2cI2qBDLKobkx/J3vWraV0T9VuG\n\
WCLKTVXkcGdtwlfFRjlBz4pYg1htmf5X6DYO8A4jqv2Il9DjXA6USbW1FzXSLr9O\n\
he8Y4IWS6wY7bCkjCWDcRQJMEhg76fsO3txE+FiYruq9RUWhiF1myv4Q6W+CyBFC\n\
Dfvp7OOGAN6dEOM4+qR9sdjoSYKEBpsr6GtPAQw4dy753ec5\n\
-----END CERTIFICATE-----\n";

        const char *client_crt = "-----BEGIN CERTIFICATE-----\n\
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\n\
-----END CERTIFICATE-----\n"; 
        const char *client_key = "-----BEGIN PRIVATE KEY-----\n\
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\n\
H5agf/aFnwRkotYkpyk2wX4YwYbjEg==\n\
-----END PRIVATE KEY-----\n";
        
        IPAddress mqtt_ip;

        //const uint16_t mqtt_port = 8883;
        const uint16_t mqtt_port = 1883;

        WiFiClient wifiClient;
        //WiFiClientSecure wifiClient;
        PubSubClient client;

        long lastMsg;
        char msg[50];
        int value;

    public:
        MqttClient();
        void init();
        void static callback(char* topic, byte* payload, unsigned int length);
        void reconnect();
        boolean isConnected();
        void loop();
        void pub(const char *msg);
};

#endif